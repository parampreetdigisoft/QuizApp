@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Manage Quizzes";
}

<style>
    body {
        background: #f4f7fb;
        font-family: "Segoe UI", sans-serif;
    }

    .table thead {
        background-color: #0d6efd;
        color: white;
    }

    .btn {
        border-radius: 10px;
    }

    .modal-content {
        border-radius: 15px;
        overflow: hidden;
    }

    .modal-header {
        font-weight: 600;
    }

    .swal2-popup {
        font-size: 1rem !important;
        border-radius: 15px !important;
    }

    .table-hover tbody tr:hover {
        background-color: #e8f0ff !important;
    }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold text-primary"><i class="bi bi-list-task me-2"></i> Manage Quizzes</h3>
        <button id="btnAddQuiz" class="btn btn-primary shadow-sm">
            <i class="bi bi-plus-circle"></i> Add Quiz
        </button>
    </div>

    <table class="table table-bordered table-hover align-middle" id="quizzesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Time Allowed</th>
                <th>Created Date</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Quiz Modal -->
<div class="modal fade" id="quizModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add / Edit Quiz</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="quizId" />
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input id="quizTitle" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="quizDescription" class="form-control"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Time Allowed (minutes)</label>
                    <input type="number" id="quizTimeAllowed" class="form-control" min="1" value="30" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveQuizBtn" class="btn btn-success">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Questions Modal -->
<div class="modal fade" id="questionsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Manage Questions for <span id="quizTitleLabel"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentQuizId" />
                <button id="btnAddQuestion" class="btn btn-sm btn-success mb-3">
                    <i class="bi bi-plus-circle"></i> Add Question
                </button>

                <table class="table table-bordered table-striped" id="questionsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Question Text</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Question Modal -->
<div class="modal fade" id="questionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Add / Edit Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="questionId" />
                <input type="hidden" id="questionQuizId" />
                <div class="mb-3">
                    <label class="form-label">Question Text</label>
                    <textarea id="questionText" class="form-control" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Points</label>
                    <input type="number" id="questionPoints" class="form-control" min="1" value="1" />
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveQuestionBtn" class="btn btn-success">Save Question</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Options Modal -->
<div class="modal fade" id="optionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Manage Options for <span id="questionLabel"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentQuestionId" />
                <button id="btnAddOption" class="btn btn-sm btn-primary mb-3">
                    <i class="bi bi-plus-circle"></i> Add Option
                </button>
                <table class="table table-bordered table-striped" id="optionsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Option Text</th>
                            <th>Is Correct</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Option Modal -->
<div class="modal fade" id="optionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">Add / Edit Option</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="optionId" />
                <input type="hidden" id="optionQuestionId" />
                <div class="mb-3">
                    <label class="form-label">Option Text</label>
                    <input id="optionText" class="form-control" />
                </div>
                <div class="form-check">
                    <input type="checkbox" id="optionIsCorrect" class="form-check-input" />
                    <label class="form-check-label">Is Correct</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveOptionBtn" class="btn btn-success">Save Option</button>
            </div>
        </div>
    </div>
</div>



    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const quizApi = "https://localhost:44302/api/quiz";
        const questionApi = "https://localhost:44302/api/question";
        const optionApi = "https://localhost:44302/api/answeroption";

        $(document).ready(function () {
            loadQuizzes();

            // === QUIZZES ===
            

            $("#btnAddQuiz").click(function () {
                $("#quizId, #quizTitle, #quizDescription").val("");
                $("#quizTimeAllowed").val(30);
                $("#quizModal").modal("show");
            });

              $("#saveQuizBtn").click(function () {
        const quiz = {
            quizId: $("#quizId").val(),
            title: $("#quizTitle").val(),
            description: $("#quizDescription").val(),
            timeAllowed: parseInt($("#quizTimeAllowed").val()) || 30
        };
        const method = quiz.quizId ? "PUT" : "POST";
        const url = quiz.quizId ? `${quizApi}/${quiz.quizId}` : quizApi;

        $.ajax({
            url,
            type: method,
            contentType: "application/json",
            data: JSON.stringify(quiz),
            success: function () {
                $("#quizModal").modal("hide");
                Swal.fire("Success", "Quiz saved successfully!", "success");
                loadQuizzes(); // ✅ reload only after success
            },
            error: function (xhr) {
                Swal.fire("Error", xhr.responseText || "Failed to save quiz", "error");
            }
        });
    });


            $(document).on("click", ".editQuiz", function () {
                const id = $(this).data("id");
                $.get(`${quizApi}/${id}`, function (quiz) {
                    $("#quizId").val(quiz.quizId);
                    $("#quizTitle").val(quiz.title);
                    $("#quizDescription").val(quiz.description);
                    $("#quizTimeAllowed").val(quiz.timeAllowed || 30);
                    $("#quizModal").modal("show");
                });
            });

            $(document).on("click", ".deleteQuiz", function () {
                const id = $(this).data("id");
                Swal.fire({
                    title: "Are you sure?",
                    text: "This quiz will be permanently deleted!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Yes, delete it!"
                }).then(result => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `${quizApi}/${id}`,
                            type: "DELETE",
                            success: function () {
                                Swal.fire("Deleted!", "Quiz deleted successfully.", "success");
                                loadQuizzes();
                            }
                        });
                    }
                });
            });

            // === QUESTIONS ===
            $(document).on("click", ".manageQuestions", function () {
                const quizId = $(this).data("id");
                const quizTitle = $(this).data("title");
                $("#quizTitleLabel").text(quizTitle);
                $("#currentQuizId").val(quizId);
                loadQuestions(quizId);
                $("#questionsModal").modal("show");
            });

             function loadQuestions(quizId) {
        $.get(`${questionApi}/by-quiz/${quizId}`, function (data) {
            let rows = "";
            if (!data || data.length === 0) {
                rows = "<tr><td colspan='3' class='text-center text-muted'>No questions found.</td></tr>";
            } else {
                $.each(data, function (i, q) {
                    rows += `
                        <tr>
                            <td>${q.id}</td>
                            <td>${q.questionText}</td>
                            <td class="text-center">
                                <button class='btn btn-sm btn-success manageOptions'
                                    data-id='${q.id}' data-text='${q.questionText}'>
                                    Options
                                </button>
                                <button class='btn btn-sm btn-warning editQuestion'
                                    data-id='${q.id}' data-text='${q.questionText}'
                                    data-points='${q.points}' data-quizid='${quizId}'>
                                    Edit
                                </button>
                                <button class='btn btn-sm btn-danger deleteQuestion' data-id='${q.id}'>
                                    Delete
                                </button>
                            </td>
                        </tr>`;
                });
            }
            $("#questionsTable tbody").html(rows);
        });
    }


            $("#btnAddQuestion").click(function () {
                $("#questionId, #questionText").val("");
                $("#questionPoints").val(1);
                $("#questionQuizId").val($("#currentQuizId").val());
                $("#questionModal").modal("show");
            });

            $("#saveQuestionBtn").click(function () {
                const q = {
                    id: $("#questionId").val(),
                    quizId: $("#questionQuizId").val(),
                    questionText: $("#questionText").val(),
                    points: parseInt($("#questionPoints").val()) || 1
                };
                const method = q.id ? "PUT" : "POST";
                const url = q.id ? `${questionApi}/${q.id}` : questionApi;

                $.ajax({
                    url, type: method,
                    contentType: "application/json",
                    data: JSON.stringify(q),
                    success: function () {
                        $("#questionModal").modal("hide");
                        Swal.fire("Success", "Question saved successfully!", "success");
                        loadQuestions($("#currentQuizId").val());
                    }
                });
                 $("#questionModal").modal("hide");
                        Swal.fire("Success", "Question saved successfully!", "success");
                        loadQuestions($("#currentQuizId").val());
            });

            $(document).on("click", ".deleteQuestion", function () {
                const id = $(this).data("id");
                Swal.fire({
                    title: "Delete this question?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!"
                }).then(res => {
                    if (res.isConfirmed) {
                        $.ajax({
                            url: `${questionApi}/${id}`,
                            type: "DELETE",
                            success: function () {
                                Swal.fire("Deleted!", "Question removed.", "success");
                                loadQuestions($("#currentQuizId").val());
                            }
                        });
                           Swal.fire("Deleted!", "Question removed.", "success");
                                loadQuestions($("#currentQuizId").val());
                    }
                });
            });

            // === OPTIONS ===
            $(document).on("click", ".manageOptions", function () {
                const qId = $(this).data("id");
                const qText = $(this).data("text");
                $("#currentQuestionId").val(qId);
                $("#questionLabel").text(qText);
                loadOptions(qId);
                $("#optionsModal").modal("show");
            });

            function loadOptions(qId) {
                $.get(`${optionApi}/by-question/${qId}`, function (data) {
                    let rows = "";
                    console.log(data);
                    if (data.length === 0)
                        rows = "<tr><td colspan='4' class='text-center text-muted'>No options found.</td></tr>";
                    else {
                        $.each(data, function (i, o) {
                            rows += `
                                <tr>
                                    <td>${o.id}</td>
                                    <td>${o.text}</td>
                                    <td>${o.isCorrect ? "✅" : "❌"}</td>
                                    <td class="text-center">
                                        <button class='btn btn-sm btn-warning editOption'
                                            data-id='${o.id}' data-text='${o.text}'
                                            data-correct='${o.isCorrect}'>Edit</button>
                                        <button class='btn btn-sm btn-danger deleteOption' data-id='${o.id}'>Delete</button>
                                    </td>
                                </tr>`;
                        });
                    }
                    $("#optionsTable tbody").html(rows);
                });
            }

            $("#btnAddOption").click(function () {
                $("#optionId, #optionText").val("");
                $("#optionIsCorrect").prop("checked", false);
                $("#optionQuestionId").val($("#currentQuestionId").val());
                $("#optionModal").modal("show");
            });

                $(document).on("click", ".deleteOption", function () {
        const id = $(this).data("id");
        if (confirm("Are you sure you want to delete this option?")) {
            $.ajax({
                url: `${optionApi}/${id}`,
                type: "DELETE",
                success: function () {
                    const qId = $("#currentQuestionId").val();
                    loadOptions(qId); // refresh options list
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                    alert("Error deleting option!");
                }
            });
        }
    });


            $("#saveOptionBtn").click(function () {
                const o = {
                    id: $("#optionId").val(),
                    questionId: $("#optionQuestionId").val(),
                    optionText: $("#optionText").val(),
                    isCorrect: $("#optionIsCorrect").is(":checked")
                };
                const method = o.id ? "PUT" : "POST";
                const url = o.id ? `${optionApi}/${o.id}` : optionApi;

                $.ajax({
                    url, type: method,
                    contentType: "application/json",
                    data: JSON.stringify(o),
                    success: function () {
                        $("#optionModal").modal("hide");
                        Swal.fire("Success", "Option saved successfully!", "success");
                        loadOptions($("#currentQuestionId").val());
                    }
                });
                $("#optionModal").modal("hide");
                        Swal.fire("Success", "Option saved successfully!", "success");
                        loadOptions($("#currentQuestionId").val());
            });
        });

        function loadQuizzes() {
         $.get(`${quizApi}/all?_=${new Date().getTime()}`, function (data) {
               
                    let rows = "";
                    $.each(data, function (i, quiz) {
                        rows += `
                            <tr>
                                <td>${quiz.quizId}</td>
                                <td>${quiz.title}</td>
                                <td>${quiz.description}</td>
                                <td>${quiz.timeAllowed ?? '-'}</td>
                                <td>${new Date(quiz.createdAt).toLocaleDateString()}</td>
                                <td class="text-center">
                                    <button class='btn btn-sm btn-success manageQuestions' data-id='${quiz.quizId}' data-title='${quiz.title}'>
                                        <i class="bi bi-question-circle"></i> Questions
                                    </button>
                                    <button class='btn btn-sm btn-warning editQuiz' data-id='${quiz.quizId}'>
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class='btn btn-sm btn-danger deleteQuiz' data-id='${quiz.quizId}'>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>`;
                    });

                    $("#quizzesTable tbody").html(rows);

                    // Re-init DataTable
                    if ($.fn.DataTable.isDataTable("#quizzesTable")) {
                        $("#quizzesTable").DataTable().destroy();
                    }
                    $("#quizzesTable").DataTable({
                        pageLength: 5,
                        order: [[0, "desc"]],
                        language: {
                            search: "🔍 Search Quiz:",
                            lengthMenu: "Show _MENU_ quizzes"
                        }
                    });
                });

            }
    </script>


