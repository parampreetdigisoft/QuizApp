@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Manage Users";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<h3 class="fw-bold mb-3">Manage Users</h3>
<button id="btnAddUser" class="btn btn-primary mb-3">
    <i class="bi bi-plus-circle"></i> Add User
</button>

<table class="table table-bordered table-hover" id="usersTable">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add / Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="userId" />
                <div class="mb-3">
                    <label>Username</label>
                    <input id="username" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Email</label>
                    <input id="email" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Role</label>
                    <select id="role" class="form-select">
                        <option>User</option>
                        <option>Admin</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Password</label>
                    <input id="password" class="form-control" type="password" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveUserBtn" class="btn btn-success">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    const apiUrl = "https://localhost:44302/api/user";

    $(function () {
        loadUsers();

        // ✅ Load all users
        function loadUsers() {
            $.get(apiUrl + "/all")
                .done(function (data) {
                    let rows = "";
                    $.each(data, function (i, user) {
                        rows += `
                            <tr>
                                <td>${user.userId}</td>
                                <td>${user.userName}</td>
                                <td>${user.email || '-'}</td>
                                <td>${user.role}</td>
                                <td>
                                    <button class='btn btn-sm btn-warning editUser' data-id='${user.userId}'>
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class='btn btn-sm btn-danger deleteUser' data-id='${user.userId}'>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>`;
                    });
                    $("#usersTable tbody").html(rows);
                })
                .fail(function (xhr) {
                    console.error("Load Error:", xhr.responseText);
                    $("#usersTable tbody").html(
                        `<tr><td colspan='5' class='text-danger text-center'>Failed to load users</td></tr>`
                    );
                });
        }

        // ✅ Open Add Modal
        $("#btnAddUser").click(function () {
            clearModal();
            $("#userModal").modal("show");
        });

        // ✅ Save (Add or Edit)
        $("#saveUserBtn").click(function () {
            const id = $("#userId").val();
            const user = {
                username: $("#username").val(),
                email: $("#email").val(),
                role: $("#role").val(),
                password: $("#password").val()
            };

            if (!user.username || !user.password) {
                alert("Username and Password are required!");
                return;
            }

            if (id) {
                // 🔁 Update existing user
                $.ajax({
                    url: apiUrl + "/" + id,
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(user)
                })
                .done(function () {
                    $("#userModal").modal("hide");
                    loadUsers();
                    alert("User updated successfully!");
                })
                .fail(function (xhr) {
                    alert("Update failed: " + xhr.responseText);
                });
            } else {
                // ➕ Create new user
                $.ajax({
                    url: apiUrl + "/register",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(user)
                })
                .done(function () {
                    $("#userModal").modal("hide");
                    loadUsers();
                    alert("User added successfully!");
                })
                .fail(function (xhr) {
                    alert("Add failed: " + xhr.responseText);
                });
            }
        });

        // ✏️ Edit User
        $(document).on("click", ".editUser", function () {
            const id = $(this).data("id");
            $.get(apiUrl + "/" + id)
                .done(function (user) {
                    $("#userId").val(user.userId);
                    $("#username").val(user.userName);
                    $("#email").val(user.email);
                    $("#role").val(user.role);
                    $("#password").val("");
                    $("#userModal").modal("show");
                })
                .fail(function () {
                    alert("Failed to load user details");
                });
        });

        // 🗑️ Delete User
        $(document).on("click", ".deleteUser", function () {
            const id = $(this).data("id");
            if (!confirm("Are you sure you want to delete this user?")) return;

            $.ajax({
                url: apiUrl + "/" + id,
                method: "DELETE"
            })
            .done(function () {
                loadUsers();
                alert("User deleted successfully!");
            })
            .fail(function (xhr) {
                alert("Delete failed: " + xhr.responseText);
            });
        });

        // 🧹 Clear modal
        function clearModal() {
            $("#userId").val("");
            $("#username").val("");
            $("#email").val("");
            $("#role").val("User");
            $("#password").val("");
        }
    });
</script>

@* <script>
    const apiUrl = "https://localhost:44302/api/user";

    $(function () {
        loadUsers();

        function loadUsers() {
            $.get(apiUrl + "/all")
                .done(function (data) {
                    console.log("API Data:", data);
                    if (!data || data.length === 0) {
                        $("#usersTable tbody").html(
                            "<tr><td colspan='5' class='text-center text-muted'>No users found</td></tr>"
                        );
                        return;
                    }

                    let rows = "";
                    $.each(data, function (i, user) {
                        rows += `
                            <tr>
                                <td>${user.userId}</td>
                                <td>${user.userName}</td>
                                <td>${user.email || '-'}</td>
                                <td>${user.role}</td>
                                <td>
                                    <button class='btn btn-sm btn-warning editUser' data-id='${user.userId}'>
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class='btn btn-sm btn-danger deleteUser' data-id='${user.userId}'>
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>`;
                    });
                    $("#usersTable tbody").html(rows);
                })
                .fail(function (xhr) {
                    console.error("API Error:", xhr.status, xhr.responseText);
                    $("#usersTable tbody").html(
                        `<tr><td colspan='5' class='text-danger text-center'>Failed to load users</td></tr>`
                    );
                });
        }
    });
</script>
 *@
